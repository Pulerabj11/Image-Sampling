#1 sample files and move to new location
from calendar import c
import os
import io
import shutil
import PySimpleGUI as sg
from itertools import islice
from PIL import Image
import random

def main():
    # Set the theme
    sg.theme("DarkAmber")

    # Set accepted file types
    acceptedFileTypes = ["jpg", "png", "tiff", "tif"]

    # Create Collection Picker window
    def make_window_collection_picker():
        sampleLayout = [[sg.Text("Source Folder Path"), sg.InputText(key="-INPUTPATH-")],
                    [sg.Text("Output Folder Path"), sg.InputText(key="-OUTPUTPATH-")],
                    [sg.Text("Choose an amount:"), sg.Slider(range=(1,100), default_value=1, size=(30, 12), orientation="horizontal", key="-SLIDER-")],
                    [sg.Button("Ok"), sg.Text("", key="-FILEINCOUNTER-", justification="right")]]

        return sg.Window("Image Sampler", sampleLayout, finalize=True)

    # Create Collection Picker window
    def make_window_image_viewer(bio, imgNum, photos, fixed_height):
        imageViewerLayout = [
            [sg.Image(data=bio.getvalue(), key="-IMAGE-")],
            [sg.Button("Prev"), sg.Text(str(imgNum+1) + " / " + str(len(photos)), key="-IMAGECOUNT-"), sg.Button("Next")]
        ]

        return sg.Window("Sample Image Viewer", imageViewerLayout, size=(1100,fixed_height+40), element_justification="c")

    # Runs the image viewer
    # Browse the sampled images
    # Save or delete the samples
    def view_sample_images(fileOut):
            # Set index to 0 for first image in imageViewerWindow
            imgNum = 0

            # Image fixed height
            fixed_height = 600

            # Get list of sample photo filenames
            for root, subdirs, photos in os.walk(fileOut):
                for name in photos:
                    splitFileName = name.split(".")
                    ext = splitFileName[1]
                    if (ext not in acceptedFileTypes):
                        photos.remove(name)

            # Set image from photos
            imgFilename = photos[imgNum]
            imgFilepath = root + "\\" + imgFilename
            os.path.exists(imgFilepath)
            image = Image.open(imgFilepath)

            # Calculate the width size based on resizing to a fixed height
            def calculate_width(image):
                height_percent = (fixed_height / float(image.size[1]))
                width_size = int((float(image.size[0]) * float(height_percent)))
                return width_size
            
            # When Prev or Next buttons are clicked, update the image and file counter
            def update_image():
                imgFilename = photos[imgNum]
                imgFilepath = root + "\\" + imgFilename

                if os.path.exists(imgFilepath):
                    image = Image.open(imgFilepath)
                    image = image.resize((calculate_width(image), fixed_height))
                    bio = io.BytesIO()
                    image.save(bio, format="PNG")
                    imageViewerWindow["-IMAGE-"].update(data=bio.getvalue())
                    imageViewerWindow["-IMAGECOUNT-"].update(str(imgNum+1) + " / " + str(len(photos)))

            # Ask the user if they want to save or delete the samples
            def ask_to_save():
                savePopupLayout = [
                    [sg.Text(text="Would you like to save this sample?")],
                    [sg.Button("Save"), sg.Button("Delete")]
                ]
                savePopup = sg.Window("",savePopupLayout, element_justification="c", keep_on_top=True, modal=True)

                # Event Loop
                while True:
                    # Get events and values from the window
                    event, values = savePopup.read()

                    if event == sg.WIN_CLOSED:
                        savePopup.close()
                        quit()

                    # If save is chosen, do nothing
                    if event == "Save":
                        savePopup.close()

                    # If delete is chosen, iterate through files and remove them
                    if event == "Delete":
                        for file in photos:
                            filepath = root + "\\" + file
                            if os.path.exists(filepath):
                                if os.access(filepath):                                
                                    os.remove(filepath)
                                else:
                                    sg.popup()
                        savePopup.close()

            # Resize image
            image = image.resize((calculate_width(image), fixed_height))

            # Save image to memory
            bio = io.BytesIO()
            image.save(bio, format="PNG")

            # Create Image Viewer window
            imageViewerWindow = make_window_image_viewer(bio, imgNum, photos, fixed_height)

            #
            # imageViewerWindow event loop
            #
            while True:
                # Get events and values from the window
                event, values = imageViewerWindow.read()
                if event == sg.WIN_CLOSED:
                    imageViewerWindow.close()
                    ask_to_save()

                if event == "Next":
                    if imgNum != len(photos)-1:
                        imgNum += 1
                        update_image()

                if event == "Prev":
                    if imgNum != 0:
                        imgNum -= 1
                        update_image()

    # Runs the Collection Picker Window
    # Enter file input and output paths
    # Pick a percentage for the sample of a collection
    def choose_collection_for_sample():

        # Create Collection Picker window
        collectionPickerWindow = make_window_collection_picker()

        # Event Loop
        while True:
            # Get events and values from the window
            event, values = collectionPickerWindow.read()

            # Set file I/O
            fileIn = "M:\\Library\\Library Units\\Archives\\Archives team\\Brandon\\UWPAC103Photos"
            # values['-INPUTPATH-'].replace("\\","\\\\")  # Location of photos to be sampled
            # fileIn = fileIn.replace("\\\\\\\\uwpfs.ad.uwp.edu\\\\Departments", "M:") # Replace if server location is given

            fileOut = "M:\\Library\\Library Units\\Archives\\Archives team\\Brandon\\SAMPLES TEST"
            # values['-OUTPUTPATH-'].replace("\\","\\\\")  # Location of photos to be sampled
            # fileOut = fileOut.replace("\\\\\\\\uwpfs.ad.uwp.edu\\\\Departments", "M:") # Replace if server location is given

            fileInCount = 1

            if event == sg.WIN_CLOSED:
                collectionPickerWindow.close()
                quit()

            # On press of "OK" button, take a sample of a collection of photos
            if event == "Ok":
                # Check for formatting issues before checking the folder paths
                if not os.path.exists(fileIn) or not os.path.exists(fileOut):
                    if not os.path.exists(fileIn):
                        sg.popup("Invalid source folder path!")
                    if not os.path.exists(fileOut):
                        sg.popup("Invalid output folder path!")
                else:
                    # Get folder data from fileIn
                    for root, subdirs, photos in os.walk(fileIn):

                        # Remove anything that isn't a photo from the list
                        for name in photos:
                            splitFileName = name.split(".")
                            ext = splitFileName[1]
                            if (ext not in acceptedFileTypes):
                                photos.remove(name)
                        
                        # User sets the percent of collection they want
                        chance = values["-SLIDER-"]

                        # Iterate through the source photos and get a sample of a given percent of them
                        for filename in islice(photos, 0, len(photos), 1):
                            collectionPickerWindow["-FILEINCOUNTER-"].update(str(fileInCount) + " / " + str(len(photos)))
                            collectionPickerWindow.refresh()
                            fileInCount+=1
                            if 100*random.random() <= chance:
                                path=os.path.join(root, filename)
                                shutil.copy(path, fileOut)

                    # If no photos were sampled, notify user
                    if len(photos) == 0:
                        sg.popup("Sample is too small! Try a larger percentage.")
                    else:
                        collectionPickerWindow.close()
                        view_sample_images(fileOut)

    # Call func to open window for choosing a collection
    choose_collection_for_sample()

# MAIN
if __name__ == "__main__":
    main()